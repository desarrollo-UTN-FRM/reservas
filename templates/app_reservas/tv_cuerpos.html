{% extends 'app_reservas/base_tv.html' %}
{% load static %}

{% block title %}
    Distribución física - Cuerpos
{% endblock title %}


{% block contenido %}
    {% for cuerpo in cuerpos %}
        <div id="cuerpo_{{ cuerpo.numero }}" class="cuerpo" data-calendario-numero="{{ forloop.counter }}">
            <h2 style="text-align: center;">{{ cuerpo.get_nombre_corto }}</h2>

            <div id="calendar_cuerpo_{{ cuerpo.numero }}" class="calendar"></div>
        </div>
    {% endfor %}
{% endblock contenido %}


{% block scripts %}
    <script>
        {% block fullcalendar_js_vars %}
            {{ block.super }}
        {% endblock fullcalendar_js_vars %}

        $(document).ready(function() {
            {% for cuerpo in cuerpos %}
                $("#calendar_cuerpo_{{ cuerpo.numero }}").fullCalendar({
                    {% block fullcalendar_defaultView %}
                        {{ block.super }}
                    {% endblock fullcalendar_defaultView %}
                    schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source',
                    lang: 'es',
                    contentHeight: 'auto',
                    minTime: '07:00:00',
                    nowIndicator: true,
                    resourceColumns: [
                        {
                            group: true,
                            labelText: 'Nivel',
                            field: 'nivel'
                        },
                        {
                            labelText: 'Recurso',
                            field: 'title'
                        },
                    ],
                    resources: [
                        {% for nivel in cuerpo.get_niveles %}
                            {% for aula in nivel.get_aulas %}
                                {
                                    id: '{{ aula.id }}',
                                    nivel: '{{ nivel.get_nombre_corto }}',
                                    title: '{{ aula.get_nombre_corto }}',
                                },
                            {% endfor %}
                            {% for laboratorio in nivel.get_laboratorios_informaticos %}
                                {
                                    id: '{{ laboratorio.id }}',
                                    nivel: '{{ nivel.get_nombre_corto }}',
                                    title: '{{ laboratorio.get_nombre_corto }}',
                                },
                            {% endfor %}
                        {% endfor %}
                    ],
                    eventSources: [
                        {% for nivel in cuerpo.get_niveles %}
                            {% for aula in nivel.get_aulas %}
                                {
                                    url: '{% url "recurso_eventos_json" aula.id %}',
                                    {% if aula.calendar_color %}
                                        color: '{{ aula.calendar_color }}',
                                    {% endif %}
                                },
                            {% endfor %}
                            {% for laboratorio in nivel.get_laboratorios_informaticos %}
                                {
                                    url: '{% url "recurso_eventos_json" laboratorio.id %}',
                                    {% if laboratorio.calendar_color %}
                                        color: '{{ laboratorio.calendar_color }}',
                                    {% endif %}
                                },
                            {% endfor %}
                        {% endfor %}
                    ],
                    header: {
                        {% block fullcalendar_header %}
                            {{ block.super }}
                        {% endblock fullcalendar_header %}
                    },
                    {% block fullcalendar_loading_callback %}
                        {{ block.super }}
                    {% endblock fullcalendar_loading_callback %}
                    {% block fullcalendar_opciones %}
                        {{ block.super }}
                    {% endblock %}
                });
            {% endfor %}

            // Función que genera la transición de cuerpos, al ir mostrando un cuerpo a la vez, y
            // ocultando los cuerpos restantes.
            function generarTransicionCuerpo() {
                // Obtiene el cuerpo visible actualmente.
                var calendario_actual = $(".cuerpo-visible");
                // Obtiene el número de calendario del cuerpo visible.
                var calendario_numero = parseInt(calendario_actual.data('calendario-numero'));
                // Calcula el número del calendario próximo a mostrarse.
                calendario_numero == {{ cuerpos|length }}
                        ? calendario_numero = 1
                        : calendario_numero++;

                // Oculta el calendario visible actualmente.
                calendario_actual.removeClass("cuerpo-visible");
                // Muestra el próximo calendario.
                $('.cuerpo[data-calendario-numero="' + calendario_numero + '"]')
                        .addClass("cuerpo-visible");
            }

            // Hace visible el primer calendario.
            $('.cuerpo[data-calendario-numero="1"]')
                        .addClass("cuerpo-visible");

            // Ejecuta la transición sólo cuando hay más de un cuerpo disponible en la vista.
            if ({{ cuerpos|length }} > 1) {
                // Establece la transición entre cuerpos cada 10 segundos.
                var timer = setInterval(generarTransicionCuerpo, 10000);
            }
        });
    </script>
{% endblock scripts %}
